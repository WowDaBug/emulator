<html>
  <head>
    <title>Emulator</title>
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        height: 100%;
      }

      #gameSelector {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 1000;
      }

      #game {
        width: 100%;
        height: 100%;
        background-color: #000;
      }
    </style>
  </head>
  <body style="background-color:#333333;">
    <select id="gameSelector" onchange="loadGame()">
      <option value="" disabled selected>Select a game</option>
      <option value="Adventure|atari2600|roms/Adventure (USA).a26">Adventure</option>
      <option value="A Link to the Past|snes|roms/Legend of Zelda, The - A Link to the Past (USA).sfc">A Link to the Past</option>
      <option value="Breakout|atari2600|roms/Breakout.bin">Breakout</option>
      <option value="Mario Kart 64|n64|roms/Mario Kart 64 (USA).n64">Mario Kart 64</option>
      <option value="Ocarina of Time|n64|roms/Legend of Zelda, The - Ocarina of Time (USA).n64">Ocarina of Time</option>
      <option value="Paper Mario|n64|roms/Paper Mario (USA).n64">Paper Mario</option>
      <option value="Pokemon Blue|gb|roms/Pokemon Blue.gb">Pokemon Blue</option>
      <option value="Pokemon Emerald|gba|roms/Pokemon - Emerald Version (USA, Europe).gba">Pokemon Emerald</option>
      <option value="Pokemon FireRed|gba|roms/1695 - Pokemon Fire Red (U)(Independent).gba">Pokemon FireRed</option>
      <option value="Pokemon LeafGreen|gba|roms/Pokemon - Leaf Green Version (U) (V1.1).gba">Pokemon LeafGreen</option>
      <option value="Pokemon Red|gb|roms/Pokemon Red (U) [S][BF].gb">Pokemon Red</option>
      <option value="Pokemon Yellow|gb|roms/Pokemon - Yellow Version (USA, Europe).gbc">Pokemon Yellow</option>
      <option value="Punch Out|nes|roms/Mike Tyson's Punch-Out!! (Japan, USA).nes">Punch Out</option>
      <option value="Sonic the Hedgehog 1|segaMD|roms/Sonic The Hedgehog (USA, Europe)">Sonic the Hedgehog 1</option>
      <option value="Sonic the Hedgehog 2|segaMD|roms/Sonic The Hedgehog 2 (World) (Rev A)">Sonic the Hedgehog 2</option>
      <option value="Sonic the Hedgehog 3|segaMD|roms/Sonic The Hedgehog 3 (Europe)">Sonic the Hedgehog 3</option>
      <option value="Sonic Advance|gba|roms/Sonic Advance (USA) (En,Ja).gba">Sonic Advance</option>
      <option value="Super Mario 64|n64|roms/Super Mario 64 (USA).z64">Super Mario 64</option>
      <option value="Super Mario All-Stars|snes|roms/Super Mario All Stars (U).smc">Super Mario All-Stars</option>
      <option value="Super Mario Bros|nes|roms/Super Mario Bros (E).nes">Super Mario Bros</option>
      <option value="Super Mario World|snes|roms/Super Mario World (U).smc">Super Mario World</option>
      <option value="Tetris (GB)|gb|roms/Tetris.gb">Tetris (GB)</option>
      <option value="Tetris (NES)|nes|roms/Tetris (USA).nes">Tetris (NES)</option>
    </select>
    <div id="game"></div>
<script>
  function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
  }

  function loadGame(preselected) {
    var select = document.getElementById("gameSelector");
    if (preselected) {
      select.value = preselected;
    }
    if (!select.value) return;

    // Stop the current game before loading a new one
    stopCurrentGame();

    // Clear the game area to prepare for the new game
    document.getElementById("game").innerHTML = "";

    var selectedGame = select.value.split("|");
    var gameName = selectedGame[0];
    var core = selectedGame[1];
    var gameUrl = selectedGame[2];

    // Set up the parameters for the new game
    EJS_player = "#game";
    EJS_core = core;
    EJS_gameName = gameName;
    EJS_color = "#0064ff";
    EJS_pathtodata = "https://cdn.emulatorjs.org/stable/data/";
    EJS_gameUrl = gameUrl;

    // Remove any existing script tag for the loader
    var existingScript = document.getElementById("emulatorScript");
    if (existingScript) {
      existingScript.remove();
    }

    // Create a new script tag to load the game
    var scriptTag = document.createElement("script");
    scriptTag.src = "https://cdn.emulatorjs.org/stable/data/loader.js";
    scriptTag.id = "emulatorScript"; // Add an ID to reference and remove the script tag later
    document.body.appendChild(scriptTag);
  }

  function stopCurrentGame() {
    // If EmulatorJS is running, stop it and reset everything
    if (typeof Emulator !== 'undefined') {
      // Attempt to stop and reset the emulator (adjust according to your emulator's actual methods)
      if (Emulator.isRunning()) {
        Emulator.stop();  // Stops the emulator
      }
      Emulator.reset(); // Resets the emulator (if available)
    }

    // Optionally clear any other global game variables or objects, e.g., clearing timeouts, intervals, etc.
    clearTimeoutsAndIntervals();
  }

  function clearTimeoutsAndIntervals() {
    // Clear any global timeouts or intervals if needed to fully reset the game state
    var highest = setTimeout(() => {});
    for (var i = 0; i < highest; i++) {
      clearTimeout(i);
      clearInterval(i);
    }
  }

  function loadGameFromURL() {
    var gameParam = getQueryParam("g");
    var hideSelector = getQueryParam("hs");
    var select = document.getElementById("gameSelector");

    if (hideSelector === "true") {
      select.style.display = "none";
    }

    if (gameParam) {
      gameParam = gameParam.replace(/\+/g, " ");
      for (var i = 0; i < select.options.length; i++) {
        if (select.options[i].text.trim().toLowerCase() === decodeURIComponent(gameParam).trim().toLowerCase()) {
          select.value = select.options[i].value;
          loadGame(select.options[i].value);
          return;
        }
      }
    }
    document.getElementById("gameSelector").selectedIndex = 0;
  }

  window.onload = loadGameFromURL;
</script>
  </body>
</html>
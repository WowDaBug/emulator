<html>
  <head>
    <title>Emulator</title>
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        height: 100%;
      }

      #gameSelector {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 1000;
      }

      #game {
        width: 100%;
        height: 100%;
        background-color: #000;
      }
    </style>
  </head>
  <body style="background-color:#333333;">
<select id="gameSelector" onchange="loadGame()">
  <option value="" disabled selected>Select a game</option>
</select>
    <div id="game"></div>
<script>
  async function loadGames() {
    try {
      const response = await fetch("games.json");
      const games = await response.json();
      const select = document.getElementById("gameSelector");

      games.forEach(game => {
        let option = document.createElement("option");
        option.value = `${game.id}|${game.core}|${game.path}`;
        option.textContent = game.name;
        select.appendChild(option);
      });

      loadGameFromURL(); // Ensure URL arguments work after loading games
    } catch (error) {
      console.error("Failed to load game list:", error);
    }
  }

  window.onload = loadGames;
</script>
    <script>
      function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
      }

      function loadGame(preselected) {
        var select = document.getElementById("gameSelector");
        if (preselected) {
          select.value = preselected;
        }
        if (!select.value) return;
        stopCurrentGame();
        document.getElementById("game").innerHTML = "";
        var selectedGame = select.value.split("|");
        var gameName = selectedGame[0];
        var core = selectedGame[1];
        var gameUrl = selectedGame[2];
        EJS_player = "#game";
        EJS_core = core;
        EJS_gameName = gameName.replace(/_/g, " ");
        EJS_color = "#0064ff";
        EJS_pathtodata = "https://cdn.emulatorjs.org/stable/data/";
        EJS_gameUrl = gameUrl;
        var existingScript = document.getElementById("emulatorScript");
        if (existingScript) {
          existingScript.remove();
        }
        var scriptTag = document.createElement("script");
        scriptTag.src = "https://cdn.emulatorjs.org/stable/data/loader.js";
        scriptTag.id = "emulatorScript";
        document.body.appendChild(scriptTag);
      }

      function stopCurrentGame() {
        if (typeof Emulator !== 'undefined') {
          if (Emulator.isRunning()) {
            Emulator.stop();
          }
          Emulator.reset();
        }
        clearTimeoutsAndIntervals();
      }

      function clearTimeoutsAndIntervals() {
        var highest = setTimeout(() => {});
        for (var i = 0; i < highest; i++) {
          clearTimeout(i);
          clearInterval(i);
        }
      }

      function loadGameFromURL() {
        var gameParam = getQueryParam("g");
        var hideSelector = getQueryParam("hs");
        var select = document.getElementById("gameSelector");
        if (hideSelector === "true") {
          select.style.display = "none";
        }
        if (gameParam) {
          gameParam = gameParam.replace(/_/g, " ");
          for (var i = 0; i < select.options.length; i++) {
            if (select.options[i].text.trim().toLowerCase() === decodeURIComponent(gameParam).trim().toLowerCase()) {
              select.value = select.options[i].value;
              loadGame(select.options[i].value);
              return;
            }
          }
        }
        document.getElementById("gameSelector").selectedIndex = 0;
      }
      window.onload = loadGameFromURL;
    </script>
  </body>
</html>